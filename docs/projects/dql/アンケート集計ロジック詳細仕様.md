## サマリー

### 医療機関からの質問への回答

**Q1. 月ごと/全期間の集計について**
- ✅ 月指定: その月のみ集計（1日00:00 ～ 月末23:59）
- ✅ 全期間: データベース内のすべての期間を集計（施設開始日に関わらず）

**Q2. 「全体」は自施設を含むか？**
- ✅ **自施設を含む**全施設のアンケート回答を集計
- システム内の全施設のデータが対象（自施設も含まれる）

**Q3. 「全体」は当年度？前年度？**
- ❌ 年度概念なし
- 「全体」= 選択中の期間（月ごと or 全期間）における全施設のデータ
  - 月選択時: その月の全施設データ
  - 全期間選択時: 全期間の全施設データ

### 重要なポイント

| 項目 | 内容 |
|------|------|
| 期間の種類 | 月ごと または 全期間（年度概念なし） |
| 全体の定義 | 自施設を含む全施設のデータ |
| 施設の重み付け | なし（回答数が多い施設ほど全体に影響） |
| データ鮮度 | リアルタイム集計（キャッシュなし） |
| 集計対象設問 | 5つの満足度設問（受付、医療スタッフ、医師、時間、施設） |
| 満足度評価 | 5段階（1=とても不満 ～ 5=最高！） |
| 契約開始日制限 | 月選択肢は契約開始日以降のみ表示（全期間は制限なし） |

### 処理フロー概要

```
[ユーザが期間選択] → [API呼び出し] → [データベース集計] → [フロント加工] → [グラフ表示]
     ↓                    ↓                  ↓                  ↓               ↓
 月/全期間         facilityId条件        GROUP BY集計      比率計算      貴院 vs 全体
                  - 自施設: ID指定       回答数カウント    総合/詳細
                  - 全体: ID="0"
```

---

## 概要

このドキュメントは、DQL2024アンケートシステムにおける集計ロジックの詳細を説明します。

---

## 1. 期間指定の仕組み

### 1.1 期間の種類

| 指定方法 | クエリパラメータ | 集計対象期間 |
|---------|-----------------|------------|
| 全期間 | `year-month=all` | データベース内のすべてのアンケート回答 |
| 月指定 | `year-month=YYYY-MM` | 指定月の1日00:00:00 ～ 月末23:59:59.999 (UTC) |

### 1.2 実装箇所

**API**: `apps/clinic/src/app/api/surveyResponse/statistics/[id]/route.ts:34-57`

```typescript
const yearMonthString = searchParams.get("year-month")
let startDate = undefined
let endDate = undefined

if (yearMonthString && yearMonthString != "all") {
  yearMonth = yearMonthString.split("-")

  // 月初: YYYY-MM-01T00:00:00.000Z
  startDate = new Date(
    Date.UTC(
      parseInt(yearMonth[0], 10),
      parseInt(yearMonth[1], 10) - 1,
      1,
      0,
    ),
  ).toISOString()

  // 月末: YYYY-MM-31T23:59:59.999Z
  endDate = new Date(
    Date.UTC(parseInt(yearMonth[0], 10), parseInt(yearMonth[1], 10), 1, 0) - 1,
  ).toISOString()
}
```

### 1.3 期間フィルタのクエリ適用

```typescript
await prismaClient.surveyResponse.groupBy({
  where: {
    ...(startDate !== undefined && {
      createdAt: { gte: startDate, lt: endDate },
    }),
  },
})
```

**重要**: `startDate = undefined` の場合、WHERE句に日付条件が追加されず、全期間が対象になります。

---

## 2. 「全体」の定義

### 2.1 自施設を含むか？

**✅ 自施設を含む全施設のデータ**

「全体」は、システムに登録されているすべての施設のアンケート回答を集計します。

### 2.2 仕組み

#### セッション生成時の処理

**ファイル**: `apps/clinic/src/lib/auth.ts:102-104`

```typescript
// 全件用のIDを暗号化
const TOTAL_ID = "0"
const encryptedTotalId = createEncryptedString(TOTAL_ID)

// セッションに格納
session.totalFacilityId = encryptedTotalId
```

#### フロントエンドでの呼び出し

**ファイル**: `apps/clinic/src/app/dashboard/DashboardContent.tsx:69-84`

```typescript
// 自施設のデータ取得
const facilityData = fetchStatisticsData(
  targetFacility?.encryptedId,  // 例: "abc123" → 施設ID=5
  selectedYearMonthString,
)

// 全体のデータ取得
const totalData = fetchStatisticsData(
  session?.totalFacilityId,     // "0" の暗号化文字列
  selectedYearMonthString,
)
```

#### API側での処理

**ファイル**: `apps/clinic/src/app/api/surveyResponse/statistics/[id]/route.ts:28-32`

```typescript
let facilityId = undefined
if (facilitySplitedId != "0") {
  facilityId = parseInt(facilitySplitedId, 10)
}
```

| 入力ID | `facilitySplitedId` | `facilityId` | クエリ結果 |
|--------|---------------------|--------------|----------|
| 自施設 | "123" | `123` | WHERE facilityId = 123 |
| 全体 | "0" | `undefined` | WHERE句に施設ID条件なし = 全施設 |

#### クエリ例

```typescript
await prismaClient.surveyResponse.count({
  where: {
    ...(facilityId != undefined && { facilityId: facilityId }),
    // facilityId = undefined の場合、このオブジェクトは展開されない
  },
})
```

**結果**:
- `facilityId = 123` → `WHERE facilityId = 123` → その施設のみ
- `facilityId = undefined` → WHERE句に施設ID条件なし → **全施設（自施設含む）**

---

## 3. 集計項目と設問

### 3.1 集計される項目

**ファイル**: `apps/clinic/src/lib/types.ts:14-26`

| Enum値 | 項目名 | 選択肢 |
|--------|--------|--------|
| `TOTAL` (0) | 総回答数 | - |
| `SEX` (1) | 性別 | 1=男性, 2=女性, 3=回答しない |
| `AGE` (2) | 年齢 | 1=19歳以下 ～ 9=90歳以上 |
| `TIME_REQUIRED_LEVEL` (3) | 診察待ち時間 | 1=10分以内 ～ 4=1時間以上 |
| `RECEPTION_LEVEL` (4) | 受付応対 | 1～5段階評価 |
| `MEDICAL_STUFF_LEVEL` (5) | 医療スタッフ応対 | 1～5段階評価 |
| `DOCTOR_LEVEL` (6) | 医師応対 | 1～5段階評価 |
| `TIME_LEVEL` (7) | 時間関連 | 1～5段階評価 |
| `FACILITY_LEVEL` (8) | 施設設備 | 1～5段階評価 |

### 3.2 満足度評価の5段階

| レベル | 意味 |
|-------|------|
| 1 | とても不満 |
| 2 | やや不満 |
| 3 | 普通 |
| 4 | やや満足 |
| 5 | 最高！ |

---

## 4. 集計処理の詳細

### 4.1 API処理フロー

**ファイル**: `apps/clinic/src/app/api/surveyResponse/statistics/[id]/route.ts`

#### ステップ1: 総回答数を取得

```typescript
const totalFacilityCount = await prismaClient.surveyResponse.count({
  where: {
    ...(facilityId != undefined && { facilityId: facilityId }),
    ...(startDate != undefined && {
      createdAt: { gte: startDate, lt: endDate },
    }),
  },
})
```

#### ステップ2: 各項目ごとにグループ集計

例: 年齢別集計（行77-107）

```typescript
counts = await prismaClient.surveyResponse.groupBy({
  by: ["age"],
  where: {
    ...(facilityId !== undefined && { facilityId: facilityId }),
    ...(startDate !== undefined && {
      createdAt: { gte: startDate, lt: endDate },
    }),
  },
  _count: {
    age: true,
  },
})

// 比率計算
ratios = counts.map((count) => ({
  count: count._count.age,
  ratio: (count._count.age / totalFacilityCount) * 100,
  level: count.age,
}))

// 回答がない年齢層を0件として追加
for (let i = 1; i <= 9; i++) {
  if (!ratios.find(({ level }) => level === i)) {
    ratios.push({
      count: 0,
      ratio: 0,
      level: i,
    })
  }
}
```

#### ステップ3: レスポンス形式

```json
{
  "0": {
    "question": "total",
    "ratios": [{ "ratio": 0, "count": 150, "level": 0 }]
  },
  "1": {
    "question": "sex",
    "ratios": [
      { "ratio": 45.3, "count": 68, "level": 1 },
      { "ratio": 54.7, "count": 82, "level": 2 }
    ]
  },
  "4": {
    "question": "receptionLevel",
    "ratios": [
      { "ratio": 2.0, "count": 3, "level": 1 },
      { "ratio": 5.3, "count": 8, "level": 2 },
      { "ratio": 20.0, "count": 30, "level": 3 },
      { "ratio": 42.7, "count": 64, "level": 4 },
      { "ratio": 30.0, "count": 45, "level": 5 }
    ]
  }
}
```

### 4.2 フロント側の加工処理

#### 回答内訳（総合）の計算

**ファイル**: `apps/clinic/src/lib/utils.ts:75-114`

```typescript
export const getSumTotalCounts = (dataArray: DataStatisticsType[]) => {
  let sumCounts: number[] = []
  let totalCount = 0

  questionnaireOptions.map((option, index) => {
    let sum = 0
    dataArray.forEach((data, i) => {
      // TIME_REQUIRED_LEVEL(=3)より後の設問のみ対象
      if (i > QuestionnaireEnum.TIME_REQUIRED_LEVEL) {
        const d = data.ratios.find((ratio) => ratio.level === option.key)
        sum += d.count
        totalCount += d.count
      }
    })
    sumCounts[index] = sum
  })

  totalRatios = sumCounts.map((count) => {
    return (count / totalCount) * 100
  })

  return [
    digitRoundFloat(totalRatios[0], -1),  // レベル1の割合
    digitRoundFloat(totalRatios[1], -1),  // レベル2の割合
    digitRoundFloat(totalRatios[2], -1),  // レベル3の割合
    digitRoundFloat(totalRatios[3], -1),  // レベル4の割合
    digitRoundFloat(totalRatios[4], -1),  // レベル5の割合
  ]
}
```

**ポイント**:
- 5つの満足度設問（受付応対、医療スタッフ応対、医師応対、時間関連、施設設備）を統合
- すべての回答を1つのデータセットとして集計
- 各レベル（1～5）の全体に占める割合を計算

#### 回答内訳（詳細）の計算

**ファイル**: `apps/clinic/src/lib/utils.ts:129-143`

```typescript
export const getDetailTotalCounts = (dataArray: DataStatisticsType[]) => {
  return questions.map((q) => {
    const levelData = dataArray[
      q.key + QuestionnaireEnum.TIME_REQUIRED_LEVEL
    ].ratios.sort((a, b) => a.level - b.level)

    return {
      name: q.name,
      level1: digitRoundFloat(levelData[0].ratio, -1),
      level2: digitRoundFloat(levelData[1].ratio, -1),
      level3: digitRoundFloat(levelData[2].ratio, -1),
      level4: digitRoundFloat(levelData[3].ratio, -1),
      level5: digitRoundFloat(levelData[4].ratio, -1),
    }
  })
}
```

**出力例**:
```javascript
[
  { name: "受付応対", level1: 2.0, level2: 5.3, level3: 20.0, level4: 42.7, level5: 30.0 },
  { name: "医療スタッフ応対", level1: 1.5, level2: 4.0, level3: 18.5, level4: 45.0, level5: 31.0 },
  { name: "医師応対", level1: 0.5, level2: 2.0, level3: 15.0, level4: 50.0, level5: 32.5 },
  { name: "時間関連", level1: 5.0, level2: 10.0, level3: 30.0, level4: 35.0, level5: 20.0 },
  { name: "施設設備", level1: 3.0, level2: 8.0, level3: 25.0, level4: 40.0, level5: 24.0 }
]
```

---

## 5. データ表示の構造

### 5.1 ダッシュボードでの表示

**ファイル**: `apps/clinic/src/app/dashboard/DashboardContent.tsx`

#### 表示項目

1. **回答内訳（総合）**: 5設問すべての回答をまとめた満足度分布
   - コンポーネント: `AnswerBreakdownAbstract`
   - 自施設 vs 全体を並べて表示

2. **回答内訳（詳細）**: 各設問ごとの満足度分布
   - コンポーネント: `AnswerBreakdownDetails`
   - 5設問それぞれの5段階評価を表示

3. **設問別集計表**: 性別、年齢、待ち時間、各満足度設問の回答数と比率
   - コンポーネント: `StatisticsTable`

### 5.2 比較表示の実装

```typescript
const facilitySummary = getSumTotalCounts(facilityData)
const totalSummary = getSumTotalCounts(totalData)

const facilityOverallData = getOverallData("貴院", facilitySummary)
const totalOverallData = getOverallData("全体", totalSummary)
const overallData = [facilityOverallData, totalOverallData]
```

**表示例（グラフ）**:

```
回答内訳（総合）

貴院: [1: 2%] [2: 5%] [3: 20%] [4: 43%] [5: 30%]
全体: [1: 3%] [2: 7%] [3: 22%] [4: 40%] [5: 28%]
```

---

## 6. 年度・期間の制限

### 6.1 年度概念の不存在

**重要**: このシステムには「当年度」「前年度」という概念がありません。

- 期間指定は「月ごと」または「全期間」のみ
- 会計年度や事業年度での集計機能はなし

### 6.2 契約開始日による制限

**ファイル**: `apps/clinic/src/app/dashboard/DashboardContent.tsx:185-206`

```typescript
// 日付設定（最初のデータの日付と契約開始日の早い方を採用）
let startYearMonth = new Date(NEXT_PUBLIC_START_MONTH)
if (targetFacility?.validFrom) {
  startYearMonth = new Date(targetFacility.validFrom)
}
if (firstResponseDate && firstResponseDate < startYearMonth) {
  startYearMonth = firstResponseDate
}

// 月選択肢を生成（今月から遡って）
let i = 0
const yearMonths: Date[] = []
const yearMonthStrings: string[] = []
do {
  yearMonths[i] = new Date(today.getFullYear(), today.getMonth() - i)
  yearMonthStrings[i] = exchangeDateToString(yearMonths[i])
  i++
} while (yearMonths[i - 1] >= startYearMonth)
```

**制限内容**:
- 月選択プルダウンには、契約開始日 (`validFrom`) より前の月は表示されない
- デフォルト開始月: `NEXT_PUBLIC_START_MONTH` = "2024-05"

### 6.3 全期間選択時の挙動

「全期間」を選択した場合:
- 契約開始日に関わらず、データベース内のすべてのアンケート回答が対象
- 施設Aの契約開始が2024年6月でも、「全体」には2024年5月からのデータが含まれる可能性がある

---

## 7. 重要な仕様と制約

### 7.1 自施設と全体の関係

| 項目 | 内容 |
|------|------|
| 全体の定義 | システム内の全施設のアンケート回答（自施設含む） |
| 比較対象 | 自施設のデータと全体のデータを並べて表示 |
| 重複排除 | なし（全体には自施設も含まれる） |

### 7.2 集計対象の範囲

| 期間指定 | 自施設 | 全体 |
|---------|--------|------|
| 月指定 | その月の自施設データ | その月の全施設データ |
| 全期間 | 自施設の全期間データ | 全施設の全期間データ |

### 7.3 施設ごとの重み付け

**なし**: 回答数が多い施設ほど「全体」の数値に影響を与えます。

例:
- 施設A: 月100件の回答
- 施設B: 月10件の回答
- 全体: 施設Aの満足度傾向が強く反映される

### 7.4 データの鮮度

- リアルタイム集計（キャッシュなし）
- ページアクセス時に毎回データベースから最新データを取得

---

## 8. よくある質問

### Q1: 「全体」は自施設を除外した他施設の平均ですか？

**A**: いいえ。「全体」は自施設を含む全施設のデータです。自施設の回答も「全体」に含まれます。

### Q2: 「全期間」を選ぶと、施設の契約開始前のデータも含まれますか？

**A**: 月選択プルダウンには契約開始前の月は表示されませんが、「全期間」を選択した場合、データベース内のすべてのアンケート回答が対象になります。ただし、その施設の回答は契約開始後のものしか存在しないため、実質的には契約開始後のデータのみが集計されます。

### Q3: 当年度と前年度を比較する機能はありますか？

**A**: ありません。月ごとまたは全期間の集計のみ対応しており、年度単位での集計機能は実装されていません。

### Q4: 回答数が少ない施設と多い施設で、「全体」への影響度は同じですか？

**A**: いいえ。回答数が多い施設ほど「全体」の数値に大きく影響します。施設ごとの重み付けや正規化は行われていません。

### Q5: 「回答内訳（総合）」と「回答内訳（詳細）」の違いは？

**A**:
- **総合**: 5設問すべての回答をまとめて、1つの満足度分布を表示
- **詳細**: 各設問ごとに独立した満足度分布を表示

### Q6: 集計から除外される設問はありますか？

**A**: はい。「回答内訳（総合）」の計算では、`TIME_REQUIRED_LEVEL`（診察待ち時間）は除外され、満足度設問（受付応対、医療スタッフ応対、医師応対、時間関連、施設設備）の5項目のみが対象です。

---

## 9. 関連ファイル一覧

| ファイルパス | 役割 |
|------------|------|
| `apps/clinic/src/app/api/surveyResponse/statistics/[id]/route.ts` | 集計データ取得API |
| `apps/clinic/src/app/api/surveyResponse/raw/[id]/route.ts` | CSV用原データ取得API |
| `apps/clinic/src/app/dashboard/DashboardContent.tsx` | ダッシュボード画面 |
| `apps/clinic/src/lib/utils.ts` | フロント側データ加工 |
| `apps/clinic/src/lib/auth.ts` | セッション生成（totalFacilityId設定） |
| `apps/clinic/src/lib/types.ts` | 型定義・Enum定義 |
| `apps/clinic/src/_components/charts/AnswerBreakdownAbstract.tsx` | 回答内訳（総合）表示 |
| `apps/clinic/src/_components/charts/AnswerBreakdownDetails.tsx` | 回答内訳（詳細）表示 |
| `db/prisma/schema.prisma` | データベーススキーマ |

---

## 10. 改訂履歴

| 日付 | 変更内容 |
|------|---------|
| 2026-01-23 | 初版作成 |

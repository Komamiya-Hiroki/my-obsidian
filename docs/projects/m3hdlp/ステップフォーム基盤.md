# short_eap_service_step 実装計画

## あなた（エンジニア）がやること

### 1. デザイナーへ技術要件を伝える

デザイナーにHTML/CSS実装を依頼する際、以下を伝えてください：

**作成ファイル**:
- `src/lp/short_eap_service_step/content.ejs` - LPのHTML
- `src/lp/short_eap_service_step/style.scss` - LPのCSS
- `src/form/short_eap_service_step/contact.ejs` - フォームのHTML（3ステップ構成）
- `src/form/short_eap_service_step/thanks.ejs` - サンクスページ
- `src/form/short_eap_service_step/scss/style.scss` - フォームのCSS

**フォーム構成**:
- ステップ1: ラジオボタンで「今の状況」を選択（2択）
- ステップ2: お名前、会社名の入力
- ステップ3: メールアドレス、電話番号、個人情報保護方針への同意

**参考**:
- 既存LP: `src/lp/short_eap_service/`
- 既存サンクス: `src/form/short_eap_service/thanks.ejs`
- ステップフォームCSS: `src/common/scss/happiness-partners/_step-form.scss`

**注意**: ステップフォームの技術的な実装（フォームID、fieldset構造など）はエンジニア側で対応するため、デザイナーは見た目とレイアウトに集中してOK

---

### 2. ディレクトリ構造とdata.json作成

```bash
mkdir -p src/lp/short_eap_service_step
mkdir -p src/form/short_eap_service_step/scss
```

`src/lp/short_eap_service_step/data.json`:

```json
{
  "title": "従業員支援プログラム（EAP）ご紹介資料",
  "description": "従業員支援プログラム（EAP）サービスの概要から導入効果まで詳しく解説。職場と従業員の健康をサポートし、パフォーマンス向上を実現するEAPの専門的なソリューションをご紹介します。",
  "keywords": "健康経営,特殊健診,データ活用,ハピネスパートナーズ,健康管理システム,一元管理,健康診断管理,健診結果管理,健診結果分析,面談記録管理,健診予約,ストレスチェック,産業保健支援,従業員の健康管理,ウェルネス経営,健診結果データ化",
  "img_path": "/img/short_document",
  "contact_form": "/form/short_eap_service_step/contact.html",
  "contact_form_thanks": "/form/short_eap_service_step/thanks.html",
  "pdf": "eap_service"
}
```

---

### 3. デザイナーのHTMLにjquery.formtowizard用の要素を追加

デザイナーから`contact.ejs`を受け取ったら、以下を追加/修正してください。

#### 必須修正チェックリスト

- [ ] **フォームIDを`wizardForm`に変更**
  ```html
  <form id="wizardForm" method="post" target="hidden_iframe" onsubmit="submitted=true;">
  ```

- [ ] **各ステップを`<fieldset>`で囲む**
  ```html
  <fieldset>
    <legend>アンケート</legend>  <!-- 進捗バーに表示される -->
    <!-- デザイナーが書いたステップ1の内容 -->
  </fieldset>

  <fieldset>
    <legend>お名前・企業名</legend>
    <!-- デザイナーが書いたステップ2の内容 -->
  </fieldset>

  <fieldset class="step__last">
    <legend>ご連絡先</legend>
    <!-- デザイナーが書いたステップ3の内容 -->
  </fieldset>
  ```

- [ ] **各fieldsetの最後に`.commands`を追加**（「次へ」「戻る」ボタンが自動挿入される）
  ```html
  <fieldset>
    <legend>アンケート</legend>
    <!-- 入力項目 -->
    <p id="step0commands" class="commands"></p>  <!-- これを追加 -->
  </fieldset>
  ```

- [ ] **必須入力項目に`class="required"`と`required`属性を追加**
  ```html
  <input type="radio" name="current_status" class="required" required>
  <input type="text" name="name" class="required" required>
  ```

- [ ] **Hidden fieldsを追加**
  ```html
  <input type="hidden" name="dkey" value="<%- pdf %>">
  <input type="hidden" name="lp_url" value="">
  <input type="hidden" name="form_url" value="">
  <input type="hidden" name="params" value="">
  ```

- [ ] **送信ボタンとiframeを追加**
  ```html
  <button type="button" id="submit_survey" style="display:none;">送信する</button>
  </form>

  <script type="text/javascript">let submitted = false;</script>
  <iframe name="hidden_iframe" id="hidden_iframe" style="display: none"
          onload="if(submitted) {window.location='thanks.html';}"></iframe>
  ```

#### フィールド名の確認

以下のname属性が正しく設定されているか確認：
- `current_status` - ステップ1のラジオボタン
- `name` - お名前
- `company_name` - 会社名
- `email` - メールアドレス
- `phone_number` - 電話番号
- `agreement_to_policy` - 同意チェックボックス

---

### 4. バリデーション設定追加

`src/form/js/step/validations.js`に追加:

```javascript
rules: {
    current_status: {          // この行を追加
        required: true
    },
    purpose: {
        required: true,
        minlength: 1
    },
    // ... 既存のルール
},
messages: {
    current_status: {          // この行を追加
        required: '選択してください'
    },
    purpose: {
        required: '一つ以上選択してください',
        minlength: '一つ以上選択してください'
    },
    // ... 既存のメッセージ
}
```

---

### 5. Google Forms連携設定

#### 5-1. Google Formsに`current_status`フィールドを追加

#### 5-2. entry IDを取得
フォームのHTMLソースからentry IDを確認

#### 5-3. config.stg.jsとconfig.prod.jsを更新

`src/form/js/environment/config.stg.js`と`config.prod.js`の両方に追加:

```javascript
static formItems = {
    current_status: { g: 'entry.XXXXXXXX' },  // ←取得したentry IDに置き換え
    name: { g: 'entry.796576750' },
    company_name: { g: 'entry.610422271' },
    email: { g: 'entry.1341853407' },
    phone_number: { g: 'entry.300598494' },
    // ... 既存のマッピング
}
```

---

### 6. ビルド確認

```bash
gulp build --env=local
```

ビルドシステムが自動的にステップフォーム用JSをバンドル（フォーム名が`*_step`のため）:
- jquery.min.js
- jquery.validate.min.js
- **jquery.formtowizard.js** - fieldsetを自動でステップ化、「次へ」「戻る」ボタン生成
- validations.js
- forms.js

---

### 7. 動作確認

```bash
gulp serve
```

`http://localhost:3000/lp/short_eap_service_step/`にアクセスして確認:

- [ ] 進捗バー（「アンケート」「お名前・企業名」「ご連絡先」）が表示される
- [ ] 「次へ」「戻る」ボタンが自動生成されている
- [ ] ステップ1で未選択時にエラーが表示される
- [ ] ステップ2で未入力時にエラーが表示される
- [ ] ステップ3で全て入力後、送信できる
- [ ] サンクスページでPDFが自動ダウンロードされる

---

## 作業の流れ

1. デザイナーに技術要件を伝える
2. data.json作成
3. バリデーション設定追加
4. Google Forms設定
5. デザイナーからHTML受領後、jquery.formtowizard用の要素を追加
6. ビルド＆動作確認

---

## コンフリクト回避

デザイナーとあなたが編集するファイルは以下の通り分離されています：

- **デザイナー**: content.ejs, style.scss, contact.ejs, thanks.ejs, フォーム用SCSS
- **あなた**: data.json, validations.js, config.*.js
- **共同編集**: contact.ejs（デザイナーが初稿作成→あなたがjquery.formtowizard用要素を追加）

contact.ejsのみ両方が触るため、デザイナーが初稿を完成させてから、あなたが技術要素を追加する流れにすればコンフリクトなし。
